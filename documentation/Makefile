# Minimal makefile for Sphinx documentation
#

# You can set these variables from the command line.
SPHINXOPTS    = --color
SPHINXBUILD   = sphinx-build
SOURCEDIR     = .
BUILDDIR      = _build
DOXYGENDIR    = .

# Put it first so that "make" without argument is like "make help".
help:
	@$(SPHINXBUILD) -M help "$(SOURCEDIR)" "$(BUILDDIR)" $(SPHINXOPTS) $(O)

.PHONY: help Makefile

# Catch-all target: route all unknown targets to Sphinx using the new
# "make mode" option.  $(O) is meant as a shortcut for $(SPHINXOPTS).
%: Makefile
	@echo -n \\033[1\;37mBuilding doxygen doc...\\033[0m
	@doxygen $(DOXYGENDIR)/Doxyfile > /dev/null
	@echo done
# fixing doxygen bug which puts typedef in every "using" statement
	@find doxygen/xml -type f -exec sed -i "s/typedef //g" {} \;
# fixing breathe bug which is confused by members of templated classes
	@find doxygen/xml -type f -exec sed -i "s/llama::Array&lt; T, T_dim &gt;::/llama::Array::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::DatumCoord&lt; T_coords &gt;::/<definition>using llama::DatumCoord::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/llama::VirtualDatum&lt; T_View &gt;::/llama::VirtualDatum::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/llama::View&lt; T_Mapping, T_BlobType &gt;::/llama::View::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::VirtualView&lt; T_ParentViewType &gt;::/<definition>using llama::VirtualView::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::Tuple&lt; T_Elements &gt;::/<definition>using llama::Tuple::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::allocator::Vector&lt; T_alignment &gt;::/<definition>using llama::allocator::Vector::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::allocator::SharedPtr&lt; T_alignment &gt;::/<definition>using llama::allocator::SharedPtr::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::allocator::Stack&lt; reserved &gt;::/<definition>using llama::allocator::Stack::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using common::allocator::Alpaka&lt; T_DevAcc, T_Size &gt;::/<definition>using common::allocator::Alpaka::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using common::allocator::AlpakaMirror&lt; T_DevAcc, T_Size, T_Mapping &gt;::/<definition>using common::allocator::AlpakaMirror::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using common::allocator::AlpakaShared&lt; T_Acc, T_count, T_uniqueID &gt;::/<definition>using common::allocator::AlpakaShared::/g" {} \;
	@find doxygen/xml -type f -exec sed -i "s/<definition>using llama::VirtualDatum&lt; T_View, T_BoundDatumDomain &gt;::/<definition>using llama::VirtualDatum::/g" {} \;
# running sphinx-build while ignoring a warning generated by breathe from valid doxygen code
	@$(SPHINXBUILD) -M $@ "$(SOURCEDIR)" "$(BUILDDIR)" $(SPHINXOPTS) $(O) 2>&1 | grep -v "WARNING: Duplicate declaration."
